name: Docker Build and Publish to GitHub Packages

on:
  push:
    tags:
      - '*'

permissions:
  packages: write
  contents: read

jobs:
  build-and-publish:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Build with Docker
        run: docker build -f release/Dockerfile --output bins .

      - name: List built binaries
        run: ls -lah bins

      - name: Create tar
        run: |
          tar -czf criu-.tar.gz -C bins .

      - name: Upload Release Asset
        uses: ncipollo/release-action@v1
        with:
          artifacts: "criu-${{ github.ref_name}}-amd64.tar.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


